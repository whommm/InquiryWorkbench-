# SmartProcure 智能采购工作台 - 项目状态说明文档

**文档版本**: 1.0
**更新日期**: 2026-02-01
**项目路径**: E:\InquiryWorkbench\smart-procure

---

## 一、项目概述

### 1.1 项目简介

SmartProcure（智能采购工作台）是一个**企业级AI驱动的采购管理系统**，旨在帮助企业采购部门高效完成供应商询价、报价管理和供应商推荐等核心业务流程。

### 1.2 核心价值

- **智能化**: 集成大语言模型（DeepSeek），通过自然语言交互完成采购操作
- **自动化**: 自动识别Excel表格结构，智能匹配供应商和产品
- **数据驱动**: 基于历史报价数据的供应商推荐系统
- **用户友好**: 类Excel的表格编辑体验，降低学习成本

### 1.3 目标用户

- 企业采购部门
- 供应链管理人员
- 询价比价专员

---

## 二、技术架构

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      前端 (React + TypeScript)               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐│
│  │  ChatPanel  │ │ UniverSheet │ │ RecommendPanel/Supplier ││
│  │  (聊天面板)  │ │ (电子表格)   │ │    (推荐/供应商面板)     ││
│  └─────────────┘ └─────────────┘ └─────────────────────────┘│
│                           │                                  │
│                    Zustand 状态管理                          │
└─────────────────────────────────────────────────────────────┘
                            │ HTTP/REST API
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    后端 (FastAPI + Python)                   │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐│
│  │ Agent运行时  │ │ Excel处理   │ │     供应商服务           ││
│  │ (LLM集成)   │ │ (表格识别)   │ │   (推荐/搜索/管理)       ││
│  └─────────────┘ └─────────────┘ └─────────────────────────┘│
│                           │                                  │
│                    SQLAlchemy ORM                            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    数据层 (SQLite)                           │
│     InquirySheet  │  Supplier  │  SupplierProduct           │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 19.2.0 | UI框架 |
| TypeScript | 5.9.3 | 类型安全 |
| Vite (Rolldown) | - | 构建工具 |
| Zustand | 5.0.10 | 状态管理 |
| Axios | 1.13.2 | HTTP客户端 |
| Tailwind CSS | 4.1.18 | 样式框架 |
| UniverJS | 0.15.3 | 电子表格引擎 |

### 2.3 后端技术栈

| 技术 | 用途 |
|------|------|
| FastAPI | Web框架 |
| Uvicorn | ASGI服务器 |
| SQLAlchemy | ORM框架 |
| Pydantic | 数据验证 |
| Pandas | 数据处理 |
| OpenPyXL | Excel处理 |
| OpenAI SDK | LLM集成（DeepSeek） |
| SQLite | 数据库 |

---

## 三、项目目录结构

```
E:\InquiryWorkbench\
├── smart-procure/
│   ├── backend/                        # 后端服务
│   │   ├── app/
│   │   │   ├── api/
│   │   │   │   └── routes.py           # API路由定义
│   │   │   ├── core/
│   │   │   │   ├── config.py           # 配置管理
│   │   │   │   └── llm.py              # LLM客户端
│   │   │   ├── models/
│   │   │   │   ├── database.py         # 数据库模型
│   │   │   │   ├── columns.py          # 表格列定义
│   │   │   │   └── types.py            # Pydantic类型
│   │   │   ├── services/
│   │   │   │   ├── supplier_service.py # 供应商服务
│   │   │   │   ├── excel_core.py       # Excel处理核心
│   │   │   │   ├── sheet_schema.py     # 表格模式识别
│   │   │   │   ├── agent_runtime.py    # AI Agent运行时
│   │   │   │   ├── web_search.py       # 网络搜索
│   │   │   │   └── supplier_extractor.py # 供应商提取
│   │   │   ├── main.py                 # 应用入口
│   │   │   └── tests/                  # 测试文件
│   │   ├── data/
│   │   │   └── smartprocure.db         # SQLite数据库
│   │   ├── scripts/                    # 数据脚本
│   │   └── requirements.txt            # Python依赖
│   │
│   ├── frontend/                       # 前端应用
│   │   ├── src/
│   │   │   ├── components/             # React组件
│   │   │   │   ├── ChatPanel.tsx       # 聊天面板
│   │   │   │   ├── UniverSheet.tsx     # 电子表格
│   │   │   │   ├── RecommendPanel.tsx  # 推荐面板
│   │   │   │   ├── SupplierPanel.tsx   # 供应商面板
│   │   │   │   ├── HistoryPanel.tsx    # 历史面板
│   │   │   │   ├── TabBar.tsx          # 标签栏
│   │   │   │   └── Layout.tsx          # 布局组件
│   │   │   ├── hooks/                  # React Hooks
│   │   │   ├── stores/                 # Zustand Store
│   │   │   ├── utils/                  # 工具函数
│   │   │   ├── App.tsx                 # 主组件
│   │   │   └── main.tsx                # 入口
│   │   ├── package.json
│   │   └── dist/                       # 构建产物
│   │
│   └── deploy/                         # 部署配置
│       ├── docker-compose.yml
│       ├── Dockerfile.backend
│       └── Dockerfile.frontend
│
└── .git/                               # Git版本控制
```

---

## 四、功能模块详情

### 4.1 智能采购表格管理

**功能描述**: 提供类Excel的表格编辑体验，支持采购询价表的创建、编辑和管理。

**核心特性**:
- 上传Excel询价表，自动识别表格结构
- 支持3个供应商报价槽位
- 实时编辑和数据同步
- 自动计算完成率

**表格结构**:
```
基础列: 序号 | 物品名称 | 规格 | 数量 | 单位 | 品牌
槽位1:  品牌1 | 备注1 | 单价1 | 含税1 | 含运1 | 货期1 | 供应商1
槽位2:  品牌2 | 备注2 | 单价2 | 含税2 | 含运2 | 货期2 | 供应商2
槽位3:  品牌3 | 备注3 | 单价3 | 含税3 | 含运3 | 货期3 | 供应商3
```

### 4.2 AI聊天助手

**功能描述**: 基于DeepSeek大语言模型的智能助手，通过自然语言交互完成采购操作。

**两阶段Agent架构**:

1. **Planner阶段**
   - 分析用户意图
   - 调用工具获取信息
   - 询问用户补充信息

2. **Executor阶段**
   - 执行数据更新操作
   - 处理报价写入
   - 管理槽位分配

**可用工具**:
| 工具名称 | 功能 |
|---------|------|
| locate_row | 按物料/品牌/型号定位行 |
| get_row_slot_snapshot | 获取行的报价槽位状态 |
| supplier_lookup | 查询供应商信息 |
| web_search_supplier | 网络搜索品牌供应商 |

### 4.3 供应商管理

**功能描述**: 完整的供应商信息管理系统。

**核心特性**:
- 供应商CRUD操作
- 供应商搜索（支持模糊匹配）
- 供应商标签管理
- 报价历史追踪
- 供应商-产品关联

### 4.4 供应商推荐系统

**功能描述**: 基于历史数据的智能供应商推荐。

**推荐算法因素**:
- 产品名称匹配度
- 规格型号匹配度
- 品牌匹配度
- 历史报价次数
- 最后报价时间
- 价格范围

**输出信息**:
- 推荐星级（1-5星）
- 历史报价次数
- 价格范围
- 联系方式

---

## 五、数据库设计

### 5.1 数据模型

#### InquirySheet（询价表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| name | String | 表格名称 |
| sheet_data | JSON | 表格数据 |
| chat_history | JSON | 聊天历史 |
| item_count | Integer | 物品数量 |
| completion_rate | Float | 完成率(0-1) |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

#### Supplier（供应商）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键（自增） |
| company_name | String | 公司名称（唯一） |
| contact_phone | String | 联系电话 |
| contact_name | String | 联系人 |
| owner | String | 所有者 |
| tags | JSON | 标签列表 |
| quote_count | Integer | 报价次数 |
| last_quote_date | DateTime | 最后报价时间 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

#### SupplierProduct（供应商-产品关联）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | Integer | 主键（自增） |
| supplier_id | Integer | 供应商ID（外键） |
| product_name | String | 产品名称 |
| product_model | String | 产品型号 |
| brand | String | 品牌 |
| last_price | Float | 最后报价 |
| quote_count | Integer | 报价次数 |
| created_at | DateTime | 创建时间 |
| updated_at | DateTime | 更新时间 |

### 5.2 数据关系

```
Supplier (1) ──────< (N) SupplierProduct
    │
    └── 一个供应商可以关联多个产品
```

---

## 六、API接口文档

### 6.1 聊天接口

#### POST /api/chat
AI聊天接口，处理用户自然语言请求。

**请求体**:
```json
{
  "message": "用户消息",
  "sheet_data": [[...]],
  "chat_history": [...]
}
```

**响应体**:
```json
{
  "action": "ASK|WRITE",
  "content": "AI回复内容",
  "updated_data": [[...]]
}
```

### 6.2 表格接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/upload | 上传Excel文件 |
| POST | /api/sheets/save | 保存询价表 |
| GET | /api/sheets/list | 获取表格列表 |
| GET | /api/sheets/{id} | 获取单个表格 |
| DELETE | /api/sheets/{id} | 删除表格 |
| GET | /api/sheets/{id}/export | 导出Excel |

### 6.3 供应商接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/suppliers/search | 搜索供应商 |
| GET | /api/suppliers/list | 获取供应商列表 |
| DELETE | /api/suppliers/{id} | 删除供应商 |
| POST | /api/suppliers/recommend | 推荐供应商 |

### 6.4 初始化接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/init | 获取初始表格结构 |

---

## 七、部署配置

### 7.1 Docker部署

**docker-compose.yml 配置**:

```yaml
services:
  backend:
    build:
      dockerfile: Dockerfile.backend
    ports:
      - "18000:18000"
    command: uvicorn app.main:app --host 0.0.0.0 --port 18000 --reload

  frontend:
    build:
      dockerfile: Dockerfile.frontend
    ports:
      - "6789:5173"
    command: npm run dev -- --host
```

### 7.2 环境变量

| 变量名 | 说明 | 示例 |
|--------|------|------|
| DEEPSEEK_API_KEY | DeepSeek API密钥 | sk-xxx |
| DATABASE_URL | 数据库连接 | sqlite:///data/smartprocure.db |

### 7.3 端口配置

| 服务 | 端口 | 说明 |
|------|------|------|
| 后端API | 18000 | FastAPI服务 |
| 前端开发 | 6789 | Vite开发服务器 |

---

## 八、开发状态

### 8.1 已完成功能

| 功能模块 | 状态 | 说明 |
|---------|------|------|
| 表格上传与识别 | ✅ 完成 | 支持Excel自动识别 |
| 多槽位报价管理 | ✅ 完成 | 支持3个供应商槽位 |
| AI聊天助手 | ✅ 完成 | 两阶段Agent架构 |
| 供应商管理 | ✅ 完成 | CRUD + 搜索 |
| 供应商推荐 | ✅ 完成 | 智能推荐算法 |
| 数据持久化 | ✅ 完成 | SQLite + IndexedDB |
| Docker部署 | ✅ 完成 | 容器化配置 |

### 8.2 最近更新记录

| 提交ID | 更新内容 |
|--------|---------|
| 9e098ff | 重构供应商推荐算法，新增SupplierProduct关联表 |
| 88ae443 | 添加供应商推荐面板功能 |
| bd5730c | 优化报价合并逻辑并添加缺失字段提醒功能 |
| a727cfb | 重构为固定位置模式并优化批量报价处理 |
| 7d49705 | 保存当前版本以便后续优化回滚 |

### 8.3 当前工作目录状态

**已修改文件**:
- `.claude/settings.local.json`
- `smart-procure/backend/app/api/routes.py`
- `smart-procure/backend/app/services/supplier_service.py`
- `smart-procure/backend/data/smartprocure.db`
- `smart-procure/frontend/src/App.tsx`
- `smart-procure/frontend/src/components/Layout.tsx`

**新增目录**:
- `smart-procure/backend/scripts/`

---

## 九、技术亮点

### 9.1 智能表格识别

系统能够自动识别多种格式的Excel询价表：

- **字段同义词支持**: 物品名称/物料名称/品名、规格/规格型号/型号等
- **槽位自动检测**: 识别报价列并自动分配槽位
- **模糊匹配**: 支持产品和供应商的模糊匹配

### 9.2 报价合并逻辑

- **去重判断**: 基于核心字段判断是否为重复报价
- **智能合并**: 新报价覆盖旧报价的非空字段
- **槽位排序**: 按价格自动排序分配槽位
- **缺失提醒**: 提示用户补充缺失的关键字段

### 9.3 推荐算法

综合考虑多个维度进行供应商推荐：
- 产品匹配度（名称、规格、品牌）
- 历史合作数据（报价次数、最后报价时间）
- 价格竞争力（历史价格范围）

---

## 十、后续规划建议

### 10.1 功能增强

- [ ] 多用户权限管理
- [ ] 报价审批流程
- [ ] 数据导出报表
- [ ] 供应商评分体系
- [ ] 价格趋势分析

### 10.2 技术优化

- [ ] 数据库迁移至PostgreSQL（生产环境）
- [ ] 添加Redis缓存层
- [ ] 实现WebSocket实时通信
- [ ] 添加单元测试覆盖
- [ ] 性能监控和日志系统

### 10.3 用户体验

- [ ] 移动端适配
- [ ] 快捷键支持
- [ ] 批量操作优化
- [ ] 离线模式支持

---

## 附录

### A. 启动命令

**后端启动**:
```bash
cd smart-procure/backend
pip install -r requirements.txt
uvicorn app.main:app --host 0.0.0.0 --port 18000 --reload
```

**前端启动**:
```bash
cd smart-procure/frontend
npm install
npm run dev
```

**Docker启动**:
```bash
cd smart-procure/deploy
docker-compose up -d
```

### B. 相关文档

- FastAPI文档: https://fastapi.tiangolo.com/
- UniverJS文档: https://univer.ai/
- DeepSeek API: https://platform.deepseek.com/

---

*文档结束*
