# ğŸš€ SmartProcure æ™ºèƒ½é‡‡è´­å·¥ä½œå° - 24å°æ—¶æé€Ÿå¼€å‘è§„æ ¼ä¹¦

## 0. ç»™ AI åŠ©æ‰‹çš„æœ€é«˜æŒ‡ä»¤ (PRIME DIRECTIVES)

* **èº«ä»½å®šä¹‰**ï¼šä½ ç°åœ¨æ˜¯é¦–å¸­å…¨æ ˆæ¶æ„å¸ˆã€‚
* **å½“å‰ä»»åŠ¡**ï¼šåŸºäº Windows æœ¬åœ° Docker ç¯å¢ƒï¼Œåœ¨ 24 å°æ—¶å†…æ„å»ºä¸€ä¸ª**å¯æ¼”ç¤ºçš„ MVP**ã€‚
* **æ ¸å¿ƒçº¢çº¿**ï¼š
1. **æ–‡ä»¶ç»“æ„**ï¼šä¸¥æ ¼éµå®ˆæœ¬æ–‡æ¡£å®šä¹‰çš„ç›®å½•æ ‘ï¼Œç¦æ­¢åœ¨æ ¹ç›®å½•åˆ›å»ºæœªå®šä¹‰çš„æ–‡ä»¶ã€‚
2. **Univer é›†æˆ**ï¼šä¸¥ç¦å°è¯•æ„å»º Univer æºç ã€‚**å¿…é¡»**é€šè¿‡ `npm` å®‰è£…å®˜æ–¹å‘è¡ŒåŒ…ï¼ˆæ–‡æ¡£ç¬¬ 3 èŠ‚å·²æŒ‡å®šï¼‰ã€‚
3. **ä¸šåŠ¡é€»è¾‘**ï¼šå¿…é¡»ä¸¥æ ¼æ‰§è¡Œæ–‡æ¡£ç¬¬ 4 èŠ‚å®šä¹‰çš„â€œä¸‰æ è”åŠ¨æ’åºç®—æ³•â€ï¼Œç¦æ­¢æ“…è‡ªä¿®æ”¹ã€‚
4. **ç¨³å®šæ€§**ï¼šæ‰€æœ‰ä»£ç æ®µå¿…é¡»å®Œæ•´ï¼Œä¸è¦çœç•¥ï¼Œç¡®ä¿æˆ‘å¤åˆ¶åèƒ½ç›´æ¥è¿è¡Œã€‚


---

## 1. ç³»ç»Ÿæ¶æ„ä¸æ–‡ä»¶åœ°å›¾ (Architecture & Map)

**ç¯å¢ƒ**ï¼šWindows 10/11 + Docker Desktop + Node.js 18+ + Python 3.9+
**ç«¯å£**ï¼šFrontend (`6789`), Backend (`18000`), Nginx (`80`)

è¯·ä¸¥æ ¼æŒ‰æ­¤ç»“æ„åˆå§‹åŒ–é¡¹ç›®ï¼š

```text
smart-procure/
â”œâ”€â”€ deploy/
â”‚   â”œâ”€â”€ docker-compose.yml          # å®šä¹‰ services: backend, frontend
â”‚   â”œâ”€â”€ Dockerfile.backend          # Python 3.9 slim, pip install requirements
â”‚   â”œâ”€â”€ Dockerfile.frontend         # Node 18 build -> Nginx alpine serve
â”‚   â””â”€â”€ nginx.conf                  # å‰ç«¯åå‘ä»£ç†é…ç½® (å…³é”®ï¼šè§£å†³è·¨åŸŸ)
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”‚   â”œâ”€â”€ config.py           # åŠ è½½ .env
â”‚   â”‚   â”‚   â””â”€â”€ llm.py              # å°è£… OpenAI/Qwen API
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â”œâ”€â”€ columns.py          # ã€å…³é”®ã€‘Excel åˆ—åå¸¸é‡å®šä¹‰
â”‚   â”‚   â”‚   â””â”€â”€ types.py            # Pydantic æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â”œâ”€â”€ excel_core.py       # Pandas è§£æã€å†™å…¥ã€æ’åºç®—æ³•
â”‚   â”‚   â”‚   â””â”€â”€ supplier_mock.py    # æœ¬åœ°ç¡¬ç¼–ç çš„ä¾›åº”å•†åº“
â”‚   â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”‚   â””â”€â”€ routes.py           # /upload, /chat, /save æ¥å£
â”‚   â”‚   â””â”€â”€ main.py                 # FastAPI App å…¥å£
â”‚   â”œâ”€â”€ requirements.txt            # fastapi, uvicorn, pandas, openpyxl, python-multipart, requests
â”‚   â””â”€â”€ .env                        # API_KEY=sk-xxx
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”‚   â”œâ”€â”€ UniverSheet.tsx     # ã€å…³é”®ã€‘Univer å°è£…ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ ChatPanel.tsx       # å·¦ä¾§å¯¹è¯æ¡†
â”‚   â”‚   â”‚   â””â”€â”€ Layout.tsx          # å·¦å³åˆ†å±å¸ƒå±€
â”‚   â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”‚   â””â”€â”€ useProcureState.ts  # ç®¡ç†è¡¨æ ¼æ•°æ®ä¸å¯¹è¯çŠ¶æ€
â”‚   â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”‚   â””â”€â”€ api.ts              # Axios å®ä¾‹
â”‚   â”‚   â”œâ”€â”€ App.tsx
â”‚   â”‚   â””â”€â”€ main.tsx
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ vite.config.ts
â”‚   â””â”€â”€ tailwind.config.js
â””â”€â”€ README.md
```

---

## 2. æ•°æ®æ ¸å¿ƒï¼šExcel ç»“æ„å®šä¹‰ (The Schema)

**èƒŒæ™¯**ï¼šExcel æ˜¯æˆ‘ä»¬çš„æ•°æ®åº“ã€‚å¿…é¡»åœ¨ `backend/app/models/columns.py` ä¸­ä¸¥æ ¼å®šä¹‰ä»¥ä¸‹å¸¸é‡ã€‚

### 2.1 åŸºç¡€åˆ— (å›ºå®šä¸åŠ¨)

```python
BASIC_COLS = ["åºå·", "ç‰©å“åç§°", "è§„æ ¼", "æ•°é‡", "å•ä½", "å“ç‰Œ"]
```

### 2.2 æŠ¥ä»· Slot æ¨¡æ¿ (ä¸‰æ ç»“æ„)

è¿™ç»„åˆ—ä¼šé‡å¤ 3 æ¬¡ï¼ˆSlot 1, Slot 2, Slot 3ï¼‰ã€‚

```python
# å•ä¸ª Slot åŒ…å«çš„å­—æ®µ
SLOT_TEMPLATE = [
    "å¤‡æ³¨", "å•ä»·", "å«ç¨", "å«è¿", "è´§æœŸ", 
    "ä¾›åº”å•†å…¨ç§°", "ä¾›åº”å•†å§“å", "ä¾›åº”å•†æ‰‹æœº"
]

# å¿…é¡»é€šè¿‡ä»£ç ç”Ÿæˆå®Œæ•´çš„ HEADERS åˆ—è¡¨ï¼š
# ["åºå·"..."å“ç‰Œ", "å¤‡æ³¨1", "å•ä»·1"..."æ‰‹æœº1", "å¤‡æ³¨2"..."æ‰‹æœº2"...]
```

---

## 3. å‰ç«¯å®æ–½ï¼šUniver é›†æˆæŒ‡å— (Frontend)

**è­¦å‘Š**ï¼šUniver é…ç½®æå…¶å¤æ‚ï¼Œè¯·ä¸¥æ ¼æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ã€‚

### 3.1 ä¾èµ–å®‰è£… (package.json)

ä¸è¦è®© AI çŒœæµ‹ç‰ˆæœ¬ï¼ŒæŒ‡å®šå®‰è£…ä»¥ä¸‹åŒ…ï¼š

```bash
npm install @univerjs/core @univerjs/design @univerjs/engine-render @univerjs/engine-formula @univerjs/sheets @univerjs/sheets-ui @univerjs/ui clsx tailwindcss
```

> **æ³¨æ„**ï¼šUniver API æ›´æ–°é¢‘ç¹ï¼Œå»ºè®®å®‰è£…æ—¶ç•™æ„ç‰ˆæœ¬å…¼å®¹æ€§ã€‚è‹¥é‡åˆ° API æŠ¥é”™ï¼Œè¯·å‚è€ƒå®˜æ–¹æœ€æ–°æ–‡æ¡£å¾®è°ƒåˆå§‹åŒ–ä»£ç ã€‚

### 3.2 UniverSheet.tsx ç»„ä»¶é€»è¾‘

æ­¤ç»„ä»¶éœ€è¦å®Œæˆ 3 ä»¶äº‹ï¼š

1. **åˆå§‹åŒ–**ï¼šåˆ›å»ºä¸€ä¸ªç©ºçš„ Workbookã€‚
2. **æ•°æ®æ³¨å…¥**ï¼šé€šè¿‡ `props.data` æ¥æ”¶åç«¯ä¼ æ¥çš„ JSONï¼Œå¹¶è°ƒç”¨ `univerAPI` é‡ç»˜è¡¨æ ¼ã€‚
3. **æ ·å¼ä¿®æ­£**ï¼šå¼•å…¥ `@univerjs/design/lib/index.css` å’Œ `@univerjs/ui/lib/index.css`ã€‚

**å…³é”®ä»£ç ç‰‡æ®µ (æŒ‡å¯¼ AI å®ç°):**

```typescript
// åˆå§‹åŒ–æ—¶å¿…é¡»æ³¨å†Œæ’ä»¶
const univer = new Univer({ theme: defaultTheme });
univer.registerPlugin(UniverRenderEnginePlugin);
univer.registerPlugin(UniverUIPlugin, { container: containerRef.current });
univer.registerPlugin(UniverSheetsPlugin);
univer.registerPlugin(UniverSheetsUIPlugin);

// åˆ›å»ºè¡¨æ ¼
univer.createUnit(UniverInstanceType.UNIVER_SHEET, {
    id: 'workbook-1',
    sheets: { 'sheet-1': { name: 'é‡‡è´­å•', cellData: props.data } }
});
```

---

## 4. åç«¯å®æ–½ï¼šä¸šåŠ¡é€»è¾‘æ ¸å¿ƒ (Backend)

### 4.1 æ ¸å¿ƒç®—æ³•ï¼šä¸‰æ è”åŠ¨æ’åº (Block Sort)

åœ¨ `backend/app/services/excel_core.py` ä¸­å®ç°ã€‚

**é€»è¾‘æè¿°**ï¼š
å½“ AI æˆ–ç”¨æˆ·å½•å…¥ä¸€ä¸ªæ–°çš„æŠ¥ä»· `New_Offer` (åŒ…å«ä»·æ ¼ P_new) åˆ°æŸä¸€è¡Œæ—¶ï¼š

1. **è¯»å–**ï¼šè·å–è¯¥è¡Œå½“å‰çš„ `Slot1` (ä»·æ ¼ P1), `Slot2` (ä»·æ ¼ P2), `Slot3` (ä»·æ ¼ P3)ã€‚
2. **æ¯”è¾ƒä¸ç§»ä½**ï¼š
* **æƒ…å†µ A (P_new < P1 æˆ– P1 ä¸ºç©º)**:
    * `Slot3` å˜ä¸ºåŸæ¥çš„ `Slot2`
    * `Slot2` å˜ä¸ºåŸæ¥çš„ `Slot1`
    * `Slot1` å˜ä¸º `New_Offer`


* **æƒ…å†µ B (P1 <= P_new < P2)**:
    * `Slot3` å˜ä¸ºåŸæ¥çš„ `Slot2`
    * `Slot2` å˜ä¸º `New_Offer`
    * `Slot1` ä¿æŒä¸å˜

* **æƒ…å†µ C (P_new >= P2)**:
    * å¦‚æœ `Slot3` ä¸ºç©º æˆ– `P_new < P3`:
        * `Slot3` å˜ä¸º `New_Offer`
        * `Slot1`, `Slot2` ä¿æŒä¸å˜
    * å¦åˆ™:
        * `New_Offer` è¢«ä¸¢å¼ƒï¼ˆä¸è¿›å…¥å‰ä¸‰ï¼‰

* **æ’åºåŸåˆ™è¡¥å……**ï¼š
    * å½“ä»·æ ¼ç›¸ç­‰æ—¶ (`==`)ï¼Œæ–°æŠ¥ä»·æ’åœ¨æ—§æŠ¥ä»·ä¹‹åï¼ˆè§†ä¸ºâ€œä¸ä¼˜äºâ€ï¼‰ï¼Œä»¥ä¿æŒç¨³å®šæ€§ã€‚
* **æ³¨æ„**ï¼šç§»åŠ¨æ—¶ï¼Œå¿…é¡»ç§»åŠ¨æ•´ä¸ª `SLOT_TEMPLATE` å®šä¹‰çš„æ‰€æœ‰å­—æ®µï¼ˆå¤‡æ³¨ã€å•ä»·...æ‰‹æœºï¼‰ï¼Œ**ä¸¥ç¦åªç§»åŠ¨ä»·æ ¼**ã€‚



### 4.2 æ™ºèƒ½ä½“é€»è¾‘ï¼šLLM çŠ¶æ€æœº (Chat Flow)

åœ¨ `backend/app/api/routes.py` çš„ `/chat` æ¥å£ä¸­å®ç°ã€‚

**System Prompt è®¾è®¡**ï¼š

> "ä½ æ˜¯ä¸€ä¸ªé‡‡è´­åˆè§„ä¸“å‘˜ã€‚
> 1. **ç°çŠ¶æ„ŸçŸ¥**ï¼šå½“å‰å¾…è¯¢ä»·ç‰©å“ä¸ºï¼š{pending_items_summary}ã€‚
> 2. **å®Œæ•´æ€§æ ¡éªŒ**ï¼šç”¨æˆ·è¾“å…¥çš„æŠ¥ä»·**å¿…é¡»**åŒ…å«ï¼šå•ä»·ã€æ˜¯å¦å«ç¨ã€æ˜¯å¦å«è¿ã€è´§æœŸã€‚
> 3. **å†³ç­–æ ‘**ï¼š
> * å¦‚æœä¿¡æ¯ç¼ºå¤± -> è¿”å› `action: "ASK"`, content: "è¯·è¡¥å……å«ç¨/å«è¿/è´§æœŸä¿¡æ¯"ã€‚
> * å¦‚æœä¿¡æ¯å®Œæ•´ -> è¿”å› `action: "WRITE"`, data: { target_row: 2, price: 100, tax: true... }ã€‚
> * ä¾›åº”å•†åŒ¹é… -> å¦‚æœç”¨æˆ·åªè¯´äº†'æ‰¾å¼ ä¸‰'ï¼Œè¯·åœ¨ data ä¸­æ ‡è®° `lookup_supplier: 'å¼ ä¸‰'`ã€‚"
> 
> 
> 
> 

**åç«¯å¤„ç†é€»è¾‘**ï¼š

* å¦‚æœæ”¶åˆ° `ASK` -> ç›´æ¥å°†é—®é¢˜è¿”å›ç»™å‰ç«¯èŠå¤©æ¡†ã€‚
* å¦‚æœæ”¶åˆ° `WRITE` ->
1. æ£€æŸ¥ `lookup_supplier` å­—æ®µï¼Œè‹¥æœ‰ï¼Œå» `supplier_mock.py` æŸ¥æ‰¾ä¾›åº”å•†ä¿¡æ¯ã€‚
   * **Merge ç­–ç•¥**ï¼šä»…è¡¥å…¨ç”¨æˆ·æœªæä¾›çš„å­—æ®µï¼ˆå¦‚æ‰‹æœºå·ã€å…¨ç§°ï¼‰ã€‚è‹¥ç”¨æˆ·åœ¨ `data` ä¸­å·²æä¾›äº†ç‰¹å®šå­—æ®µï¼ˆå¦‚ç”¨æˆ·è¯´â€œå¼ ä¸‰æ–°æ‰‹æœº 138...â€ï¼‰ï¼Œåˆ™ä»¥ç”¨æˆ·è¾“å…¥ä¸ºå‡†ï¼Œ**ä¸¥ç¦è¦†ç›–**ã€‚
2. è°ƒç”¨ **4.1 çš„æ’åºç®—æ³•** æ›´æ–° Excelã€‚
3. è¿”å›æ›´æ–°åçš„**å…¨é‡è¡¨æ ¼æ•°æ®**ç»™å‰ç«¯ã€‚



---

## 5. æ¼”ç¤ºå‰§æœ¬æ•°æ® (Mock Data)

ä¸ºäº†ç¡®ä¿æ¼”ç¤º 100% æˆåŠŸï¼Œè¯·åœ¨ `backend/app/services/supplier_mock.py` ä¸­ç¡¬ç¼–ç ä»¥ä¸‹æ•°æ®ï¼š

```python
MOCK_SUPPLIERS = {
    "å¼ ä¸‰": {"full_name": "è‹å·æ¯”é«˜æœºç”µæœ‰é™å…¬å¸", "contact": "å¼ ä¸‰", "phone": "139-8888-6666", "tags": ["è¥¿é—¨å­", "ç”µæœº"]},
    "æå››": {"full_name": "ä¸Šæµ·ç”µæ°”æˆå¥—è®¾å¤‡å‚", "contact": "æå››", "phone": "136-1234-5678", "tags": ["è¯ºå¾·", "å‡é€Ÿæœº"]}
}
```

---

## 6. æ‰§è¡Œæ­¥éª¤ (Execution Plan)

è¯·æŒ‰ä»¥ä¸‹é¡ºåºä¸€æ­¥æ­¥ç”Ÿæˆä»£ç ï¼š

1. **Step 1: åŸºç¡€è®¾æ–½** -> ç”Ÿæˆ Docker é…ç½®å’Œ requirements.txtã€‚
2. **Step 2: åç«¯æ ¸å¿ƒ** -> ç”Ÿæˆ `models/columns.py` å’Œ `services/excel_core.py` (å…ˆè·‘é€šæ’åºç®—æ³•)ã€‚
3. **Step 3: å‰ç«¯æ¡†æ¶** -> åˆå§‹åŒ– Vite é¡¹ç›®ï¼Œå®‰è£… Univer ä¾èµ–ï¼Œç”Ÿæˆ `UniverSheet.tsx`ã€‚
4. **Step 4: è”è°ƒé€»è¾‘** -> å®ç° `/chat` æ¥å£ï¼Œå¯¹æ¥ LLMï¼Œå®Œæˆâ€œå¯¹è¯ -> æ’åº -> è¡¨æ ¼æ›´æ–°â€çš„é—­ç¯ã€‚

**è¯·å…ˆç¡®è®¤ä½ å·²ç†è§£ä¸Šè¿°æ‰€æœ‰éœ€æ±‚ï¼Œå¹¶ä» Step 1 å¼€å§‹è¾“å‡ºä»£ç ã€‚**
